name: Build

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

# Cancel previous runs if a new one is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Dorg.gradle.parallel=true -Dorg.gradle.jvmargs="-Xmx4g"

jobs:
  # Quick build check without running tests
  build-check:
    name: Build Check (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: Linux
            os: ubuntu-latest
            build-tasks: 'compileKotlinLinuxX64 compileKotlinJvm'
            setup-android: false
            setup-emscripten: false
          - platform: macOS
            os: macos-14
            build-tasks: 'compileKotlinMacosArm64 compileKotlinMacosX64 compileKotlinIosArm64 compileKotlinIosSimulatorArm64'
            setup-android: false
            setup-emscripten: false
          - platform: Windows
            os: windows-latest
            build-tasks: 'compileKotlinMingwX64'
            setup-android: false
            setup-emscripten: false
          - platform: Web
            os: ubuntu-latest
            build-tasks: 'compileKotlinJs compileKotlinWasmJs compileKotlinWasmWasi'
            setup-android: false
            setup-emscripten: true
          - platform: Android
            os: ubuntu-latest
            build-tasks: 'compileDebugKotlinAndroid compileKotlinAndroidNativeArm64'
            setup-android: true
            setup-emscripten: false

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          gradle-home-cache-cleanup: true

      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential

      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake ninja

          # Add cross-compilation toolchains tap
          brew tap messense/macos-cross-toolchains

          # Install Zig for cross-compilation
          brew install zig || true

          # Install Linux cross-compilation toolchains
          brew install x86_64-unknown-linux-gnu || true
          brew install aarch64-unknown-linux-gnu || true

          # Install MinGW for Windows cross-compilation
          brew install mingw-w64 || true

      - name: Install dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install cmake ninja mingw -y

      - name: Setup MinGW paths (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          echo "C:\ProgramData\chocolatey\lib\mingw\tools\install\mingw64\bin" >> $GITHUB_PATH
          echo "C:\tools\mingw64\bin" >> $GITHUB_PATH

      - name: Select Xcode (macOS)
        if: runner.os == 'macOS'
        run: |
          sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
          xcodebuild -version

      - name: Setup Emscripten
        if: matrix.setup-emscripten
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.51'
          actions-cache-folder: 'emsdk-cache'

      - name: Verify Emscripten
        if: matrix.setup-emscripten
        run: |
          emcc --version
          which emcc

      - name: Setup Android SDK
        if: matrix.setup-android
        uses: android-actions/setup-android@v3

      - name: Install Android components
        if: matrix.setup-android
        run: |
          echo "y" | sdkmanager "platform-tools"
          echo "y" | sdkmanager "build-tools;34.0.0"
          echo "y" | sdkmanager "platforms;android-34"
          echo "y" | sdkmanager "ndk;26.1.10909125"
          echo "y" | sdkmanager "cmake;3.22.1"

      - name: Set Android environment
        if: matrix.setup-android
        run: |
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV

      - name: Cache Kotlin/Native
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-${{ matrix.platform }}-konan-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.platform }}-konan-
            ${{ runner.os }}-konan-

      - name: Cache Capstone builds
        uses: actions/cache@v4
        with:
          path: |
            build/capstone
            library/interop/lib
          key: ${{ runner.os }}-${{ matrix.platform }}-capstone-${{ hashFiles('library/interop/capstone/**') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.platform }}-capstone-
            ${{ runner.os }}-capstone-

      - name: Build targets
        run: ./gradlew ${{ matrix.build-tasks }} --continue --stacktrace

  # Build all targets (comprehensive) - macOS only as it can cross-compile
  build-all:
    name: Build All Targets
    runs-on: macos-14
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          gradle-home-cache-cleanup: true

      - name: Install build dependencies
        run: |
          brew install cmake ninja

      - name: Setup cross-compilation toolchains
        run: |
          # Add cross-compilation toolchains tap
          brew tap messense/macos-cross-toolchains

          # Install Zig for cross-compilation
          brew install zig || true

          # Install Linux cross-compilation toolchains
          brew install x86_64-unknown-linux-gnu || true
          brew install aarch64-unknown-linux-gnu || true

          # Install MinGW for Windows cross-compilation
          brew install mingw-w64 || true

      - name: Select Xcode
        run: |
          sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer
          xcodebuild -version
          xcodebuild -showsdks

      - name: Verify Xcode SDKs
        run: |
          echo "=== Available Apple SDKs ==="
          xcodebuild -showsdks | grep -i sdk
          echo ""
          echo "=== iOS SDKs ==="
          ls -la "$(xcode-select -p)/Platforms/iPhoneOS.platform/Developer/SDKs/" || true
          echo ""
          echo "=== watchOS SDKs ==="
          ls -la "$(xcode-select -p)/Platforms/WatchOS.platform/Developer/SDKs/" || true
          echo ""
          echo "=== tvOS SDKs ==="
          ls -la "$(xcode-select -p)/Platforms/AppleTVOS.platform/Developer/SDKs/" || true
          echo ""
          echo "=== Cross-Compilation Tools ==="
          zig version || echo "Zig not installed"
          x86_64-unknown-linux-gnu-gcc --version || echo "Linux x64 toolchain not installed"
          aarch64-unknown-linux-gnu-gcc --version || echo "Linux ARM64 toolchain not installed"
          x86_64-w64-mingw32-gcc --version || echo "MinGW x64 not installed"

      - name: Cache Kotlin/Native
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-all-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-konan-all-
            ${{ runner.os }}-konan-

      - name: Cache Capstone builds
        uses: actions/cache@v4
        with:
          path: |
            build/capstone
            library/interop/lib
          key: ${{ runner.os }}-capstone-all-${{ hashFiles('library/interop/capstone/**') }}
          restore-keys: |
            ${{ runner.os }}-capstone-all-
            ${{ runner.os }}-capstone-

      - name: Build Capstone for all targets
        run: ./gradlew buildCapstoneAll --stacktrace

      - name: Build all Kotlin targets
        run: ./gradlew build -x test --stacktrace

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-outputs
          path: |
            library/build/libs/
            library/interop/lib/
          retention-days: 7

  # Build with Emscripten for WASM targets
  build-wasm:
    name: Build WASM Targets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          gradle-home-cache-cleanup: true

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build build-essential python3

      - name: Setup Emscripten SDK
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: '3.1.51'
          actions-cache-folder: 'emsdk-cache'

      - name: Verify Emscripten
        run: |
          echo "=== Emscripten Verification ==="
          emcc --version
          em++ --version
          emcmake --version
          which emcc
          echo ""
          echo "=== Emscripten System ==="
          emcc -v
          echo ""
          echo "=== LLVM Tools ==="
          llvm-nm --version || echo "llvm-nm not in PATH"
          ls -la $(dirname $(which emcc))/llvm-nm || echo "llvm-nm not found in emscripten dir"

      - name: Cache Kotlin/Native
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-wasm-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-konan-wasm-
            ${{ runner.os }}-konan-

      - name: Cache Capstone WASM builds
        uses: actions/cache@v4
        with:
          path: |
            build/capstone_wasm_build
            library/src/webMain/resources
            library/src/wasmWasiMain/resources
          key: ${{ runner.os }}-capstone-wasm-${{ hashFiles('library/interop/capstone/**') }}
          restore-keys: |
            ${{ runner.os }}-capstone-wasm-

      - name: Build Capstone WASM
        run: |
          ./gradlew buildCapstoneWasmJs buildCapstoneWasmWasi --stacktrace

      - name: Build WASM Kotlin targets
        run: |
          ./gradlew compileKotlinJs compileKotlinWasmJs compileKotlinWasmWasi --stacktrace

      - name: Upload WASM artifacts
        uses: actions/upload-artifact@v4
        with:
          name: wasm-outputs
          path: |
            library/build/compileSync/
            library/src/webMain/resources/
            library/src/wasmWasiMain/resources/
          retention-days: 7

  # Build Android with NDK
  build-android:
    name: Build Android Targets
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          gradle-home-cache-cleanup: true

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK components
        run: |
          echo "=== Installing Android SDK components ==="
          echo "y" | sdkmanager "platform-tools"
          echo "y" | sdkmanager "build-tools;34.0.0"
          echo "y" | sdkmanager "platforms;android-34"
          echo "y" | sdkmanager "ndk;26.1.10909125"
          echo "y" | sdkmanager "cmake;3.22.1"
          echo ""
          echo "=== Installed packages ==="
          sdkmanager --list_installed

      - name: Set Android environment
        run: |
          echo "ANDROID_HOME=$ANDROID_HOME" >> $GITHUB_ENV
          echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
          echo "ANDROID_NDK_ROOT=$ANDROID_SDK_ROOT/ndk/26.1.10909125" >> $GITHUB_ENV
          echo "$ANDROID_SDK_ROOT/ndk/26.1.10909125/toolchains/llvm/prebuilt/linux-x86_64/bin" >> $GITHUB_PATH

      - name: Verify Android NDK
        run: |
          echo "=== Android NDK Verification ==="
          echo "ANDROID_NDK_ROOT: $ANDROID_NDK_ROOT"
          ls -la "$ANDROID_NDK_ROOT" || echo "NDK not found"
          echo ""
          echo "=== NDK Toolchains ==="
          ls -la "$ANDROID_NDK_ROOT/toolchains/llvm/prebuilt/linux-x86_64/bin/" || echo "Toolchain not found"
          echo ""
          echo "=== CMake Toolchain ==="
          ls -la "$ANDROID_NDK_ROOT/build/cmake/android.toolchain.cmake" || echo "CMake toolchain not found"

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build

      - name: Cache Kotlin/Native
        uses: actions/cache@v4
        with:
          path: ~/.konan
          key: ${{ runner.os }}-konan-android-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-konan-android-
            ${{ runner.os }}-konan-

      - name: Cache Capstone Android builds
        uses: actions/cache@v4
        with:
          path: |
            build/capstone
            library/interop/lib
            library/interop/linked-android
          key: ${{ runner.os }}-capstone-android-${{ hashFiles('library/interop/capstone/**') }}
          restore-keys: |
            ${{ runner.os }}-capstone-android-

      - name: Build Capstone for Android
        run: |
          ./gradlew buildCapstoneAndroidArm64Shared buildCapstoneAndroidArm32Shared --stacktrace

      - name: Build Android Kotlin targets
        run: |
          ./gradlew compileDebugKotlinAndroid compileKotlinAndroidNativeArm64 --stacktrace

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-outputs
          path: |
            library/build/intermediates/
            library/interop/linked-android/
          retention-days: 7

  # Code quality checks
  quality-checks:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-read-only: ${{ github.ref != 'refs/heads/main' }}
          gradle-home-cache-cleanup: true

      - name: Run detekt (if configured)
        run: ./gradlew detekt --continue --stacktrace || true

      - name: Run API check
        run: ./gradlew apiCheck --continue --stacktrace || true

      - name: Check binary compatibility
        run: ./gradlew apiDump --continue --stacktrace || true

  # Summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-check, build-wasm, build-android]
    if: always()

    steps:
      - name: Check build results
        run: |
          echo "=== Build Results Summary ==="
          echo "Build Check: ${{ needs.build-check.result }}"
          echo "WASM Build:  ${{ needs.build-wasm.result }}"
          echo "Android Build: ${{ needs.build-android.result }}"
          echo "=========================="

          if [ "${{ needs.build-check.result }}" != "success" ] || \
             [ "${{ needs.build-wasm.result }}" != "success" ] || \
             [ "${{ needs.build-android.result }}" != "success" ]; then
            echo "❌ Some builds failed"
            exit 1
          else
            echo "✅ All builds passed"
          fi
