# Kapstone

Kapstone is a powerful Kotlin Multiplatform binding for the [Capstone](https://www.capstone-engine.org/) disassembly framework. It brings the comprehensive capabilities of Capstone to the Kotlin ecosystem, enabling binary analysis and disassembly on JVM, Android, Native (macOS, Linux, Windows), and the Web (JS, Wasm).

## ‚ö†Ô∏è Beta Notice

**This project is currently in BETA.**

Please be aware that the APIs are currently evolving and are subject to change without strict deprecation cycles. The library is currently lightly tested across all targets. While we strive for stability, we recommend thorough testing if you plan to use this in production environments.

## Features

-   **Multiplatform Support**: Seamlessly run on JVM, Android, macOS (Apple Silicon & Intel), Linux, Windows (MinGW), and Web (JS & Wasm).
-   **Idiomatic Kotlin API**: Enhances the raw C API with Kotlin's type safety, `Result` types, and resource management (`use` blocks).
-   **Comprehensive Architecture Support**: Supports all major architectures provided by Capstone (ARM, ARM64, X86, MIPS, PowerPC, etc.).

## Installation & Building

Since this project is currently in beta, you may need to build it from source to get the latest changes or if artifacts are not yet published to a public repository.

### Prerequisites

-   JDK 17 or higher.
-   CMake and a C compiler (GCC/Clang) for building the native shared libraries.
-   Android NDK (optional, for Android targets).
-   Emscripten (optional, for Web/Wasm targets).

### Building form Source

To build the library and all its underlying native dependencies, run:

```bash
./gradlew buildCapstoneAll
```

This task will compile the Kotlin code and also trigger the build of the embedded Capstone C library for all enabled targets on your host machine.

## Usage

Kapstone provides a high-level, safe API around the Capstone engine.

### Basic Disassembly

Here is a simple example of how to initialize the engine and disassemble some machine code:

```kotlin
import ca.moheektech.capstone.api.CapstoneEngine
import ca.moheektech.capstone.enums.Architecture
import ca.moheektech.capstone.enums.Mode

fun main() {
    // 1. Initialize the engine (ARM64, Little Endian)
    // The 'use' block ensures the engine is closed and resources are freed automatically.
    CapstoneEngine.build(Architecture.ARM64, Mode.LITTLE_ENDIAN) {
        detail = true // Enable detailed instruction analysis (operands, groups, etc.)
    }.use { engine ->
        
        // 2. Prepare code to disassemble (e.g., MOV X0, #1)
        val code = byteArrayOf(0x20, 0x00, 0x80, 0xd2.toByte())
        val address = 0x1000L

        // 3. Disassemble
        engine.disassemble(code, address).onSuccess { instructions ->
            println("Disassembled ${instructions.size} instructions:")
            instructions.forEach { insn ->
                println("0x${insn.address.toString(16)}: ${insn.mnemonic} ${insn.opStr}")
            }
        }.onFailure { error ->
            println("Failed to disassemble: $error")
        }
    }
}
```

### Advanced Configuration

You can configure various options like syntax style (Intel/AT&T) or skip-data mode using the builder:

```kotlin
val engine = CapstoneEngine.build(Architecture.X86, Mode.MODE_64) {
    syntax = ca.moheektech.capstone.enums.Syntax.INTEL
    detail = true
    skipData = true
}
```

## üåê Wasm & Web Artifacts

Kapstone supports running in the browser and Node.js via Kotlin/Wasm and Kotlin/JS. However, because the library relies on an underlying C implementation compiled to WebAssembly, there are specific deployment requirements.

### Important: Publishing Web Artifacts

When you build your application for the web, the standard Kotlin build tasks might not automatically place the required C-level artifacts in your distribution folder.

**You must manually ensure the following files are copied to your final web distribution directory:**

1.  **Wrapper**: The JavaScript glue code generated by Emscripten (often named `capstone.js` or similar, depending on build).
2.  **Wasm Implementation**: The compiled WebAssembly binary (`capstone.wasm`).

These files are typically generated in the build output of the `wasmJs` or `wasmWasi` targets (e.g., inside `library/build/` or resources folders). Without these files accessible at runtime, the library will fail to initialize.

---

*Kapstone - Disassembly for the Kotlin Era.*
